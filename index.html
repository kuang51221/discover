<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trystero with Firebase (ES Modules)</title>
</head>
<body>
  <h1>Trystero with Firebase (ES Modules)</h1>
  
  <div>
    <label for="roomId">Room ID:</label>
    <input type="text" id="roomId" value="default-room">
    <button id="joinBtn">Join Room</button>
  </div>
  
  <div>
    <h2>Local Video</h2>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  
  <div>
    <h2>Remote Videos</h2>
    <div id="remoteVideos"></div>
  </div>
  
  <div>
    <h2>Messages</h2>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
    <ul id="messages"></ul>
  </div>

  <!-- 使用 ES Modules 方式導入 -->
  <script type="module">
    // 導入 Trystero
    // 注意: 你需要確保 trystero-torrent.min.js 文件存在於指定路徑
    // 或者使用 CDN 的模塊化版本
    import { joinRoom } from './trystero-torrent.min.js';
    
    // Firebase 導入 (使用兼容模塊化版本的 Firebase)
    //import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js';
    //import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
    import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js';

    // 你的 Firebase 配置
    const firebaseConfig = {
    apiKey: "AIzaSyD8HLyXGtBX_m_qlGTSEzSwDJaqRpVF0og",
    authDomain: "netdot-2a73d.firebaseapp.com",
    databaseURL: "https://netdot-2a73d-default-rtdb.firebaseio.com",
    projectId: "netdot-2a73d",
    storageBucket: "netdot-2a73d.firebasestorage.app",
    messagingSenderId: "560775014527",
    appId: "1:560775014527:web:e02ca859dabb60632cf74a"
  };
      
    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    let room;
    let localStream;
    let peers = {};
    
    // 配置 Trystero
      const appId = 'your-app-id';
      const config = {appId, provider: 'firebase', firebaseConfig};
    
    // 加入房間
    document.getElementById('joinBtn').addEventListener('click', async () => {
      const roomId = document.getElementById('roomId').value;
      const room = joinRoom(config, roomId, {
        stream: true,
        data: true
      });
      
      
      try {
        // 使用導入的 joinRoom 函數
        room = joinRoom(config, roomId, {
          stream: true,
          data: true
        });
        
        // 設置事件監聽
        setupRoomListeners(room);
        
        // 獲取本地媒體流
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: true
        });
        
        // 顯示本地視頻
        document.getElementById('localVideo').srcObject = localStream;
        
        // 發送流給其他對等端
        room.addStream(localStream);
      } catch (error) {
        console.error('Error joining room:', error);
      }
    });
    
    // 設置房間事件監聽
    function setupRoomListeners(room) {
      // 當對等端加入時
      room.onPeerJoin(peerId => {
        console.log('peer joined:', peerId);
        peers[peerId] = {id: peerId};
      });
      
      // 當對等端離開時
      room.onPeerLeave(peerId => {
        console.log('peer left:', peerId);
        const videoContainer = document.getElementById(`remote-${peerId}`);
        if (videoContainer) {
          videoContainer.remove();
        }
        delete peers[peerId];
      });
      
      // 接收到流時
      room.onPeerStream((stream, peerId) => {
        console.log('got stream from:', peerId);
        
        const video = document.createElement('video');
        video.id = `video-${peerId}`;
        video.autoplay = true;
        video.playsInline = true;
        video.srcObject = stream;
        
        const container = document.createElement('div');
        container.id = `remote-${peerId}`;
        container.innerHTML = `<p>Peer: ${peerId}</p>`;
        container.appendChild(video);
        
        document.getElementById('remoteVideos').appendChild(container);
      });
      
      // 接收到消息時
      room.onPeerMessage((data, peerId) => {
        console.log('got message from:', peerId, data);
        const li = document.createElement('li');
        li.textContent = `[${peerId}]: ${data}`;
        document.getElementById('messages').appendChild(li);
      });
    }
    
    // 發送消息按鈕點擊事件
    document.getElementById('sendBtn').addEventListener('click', () => {
      const message = document.getElementById('messageInput').value;
      if (message && room) {
        room.sendMessage(message);
        const li = document.createElement('li');
        li.textContent = `[You]: ${message}`;
        document.getElementById('messages').appendChild(li);
        document.getElementById('messageInput').value = '';
      }
    });
  </script>
</body>
</html>
